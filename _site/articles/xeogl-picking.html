<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>GPU-Assisted Picking in xeogl &#8211; xeolabs</title>
<meta name="description" content="A multi-layer color-indexing rendering algorithm which ray-picks 3D scene objects in linear time">
<meta name="keywords" content="xeogl, picking, webgl">
<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://xeolabs.com/images/">
<meta name="twitter:title" content="GPU-Assisted Picking in xeogl">
<meta name="twitter:description" content="A multi-layer color-indexing rendering algorithm which ray-picks 3D scene objects in linear time">
<meta name="twitter:creator" content="@xeolabs">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="GPU-Assisted Picking in xeogl">
<meta property="og:description" content="A multi-layer color-indexing rendering algorithm which ray-picks 3D scene objects in linear time">
<meta property="og:url" content="http://xeolabs.com/articles/xeogl-picking">
<meta property="og:site_name" content="xeolabs">





<link rel="canonical" href="http://xeolabs.com/articles/xeogl-picking">
<link href="http://xeolabs.com/feed.xml" type="application/atom+xml" rel="alternate" title="xeolabs Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700|PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
<!-- For all browsers -->
<link rel="stylesheet" href="http://xeolabs.com/assets/css/main.min.css">

<!--[if (lt IE 9) & (!IEMobile)]>
<link rel="stylesheet" href="http://xeolabs.com/assets/css/ie.min.css">
<![endif]-->

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://xeolabs.com/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://xeolabs.com/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://xeolabs.com/favicon-32x32.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://xeolabs.com/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://xeolabs.com/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://xeolabs.com/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://xeolabs.com/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="article" itemscope itemtype="http://schema.org/WebPage">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="http://xeolabs.com/">xeolabs</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
		    <ul>
		        
				<li><a href="http://xeolabs.com/index" >About</a></li>
		        
				<li><a href="http://xeolabs.com/articles" >Blog</a></li>
		        
				<li><a href="http://xeolabs.com/portfolio" >Portfolio</a></li>
		        
				<li><a href="http://xeolabs.com/pdfs/lindsaykay_resume_2019.pdf" >Resume</a></li>
		        
				<li><a href="http://linkedin.com/in/lindsaystanleykay" target="_blank">LinkedIn</a></li>
		        
				<li><a href="http://xeolabs.com/contact" >Contact</a></li>
		        
				<li><a href="http://xeogl.org" target="_blank">xeogl</a></li>
		        
				<li><a href="http://xeokit.io" target="_blank">xeokit</a></li>
		        

		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main" itemprop="mainContentOfPage" itemscope itemtype="http://schema.org/Blog">
  <div class="article-author-top">
    <img src="http://xeolabs.com/images/avatar.jpg" class="bio-photo" alt="xeolabs bio photo"></a>
<h3><a href="http://xeolabs.com/about/">xeolabs</a></h3>
<p><b>Lindsay Kay</b><br><br><i>3D software engineer / WebGL developer</i></p>
<a href="http://twitter.com/xeolabs" class="author-social" target="_blank"><i class="icon-twitter"></i> Twitter</a>
<a href="http://linkedin.com/in/lindsaystanleykay" class="author-social" target="_blank"><i class="icon-linkedin"></i> LinkedIn</a>
<a href="http://github.com/xeolabs" class="author-social" target="_blank"><i class="icon-github"></i> Github</a>
<br>
<hr>
<p style="text-align: center;"><a href="http://xeolabs.com/pdfs/OpenGLInsights.pdf"><img style="text-align: center; width: 80%;" src="http://xeolabs.com/images/scenejs/OpenGLInsights2.jpg"></a><br>
    <i>My chapter on <a href="http://scenejs.org">SceneJS</a> for OpenGL Insights is now <a href="http://xeolabs.com/pdfs/OpenGLInsights.pdf">free to download!</a></i></p>

  </div>
  <article itemscope itemtype="http://schema.org/BlogPosting" itemprop="blogPost">
    <div class="headline-wrap">
      <h1 itemprop="name">GPU-Assisted Picking in xeogl</h1>
        <p style="font-weight:bold; font-style:italic;"><time datetime="2017-08-01T00:00:00+00:00" itemprop="datePublished">August 01, 2017</time></p>
    </div><!--/ .headline-wrap -->
    <div class="article-wrap" itemprop="text">
      <section id="table-of-contents" class="toc">
  <header>
    <h3>Contents</h3>
  </header>
<div id="drawer">
<ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
  <li><a href="#four-types-of-picking-in-xeogl" id="markdown-toc-four-types-of-picking-in-xeogl">Four types of picking in xeogl</a></li>
  <li><a href="#pick-entity-at-canvas-coordinates" id="markdown-toc-pick-entity-at-canvas-coordinates">1. Pick entity at canvas coordinates</a></li>
  <li><a href="#pick-point-on-entity-surface-at-canvas-coords" id="markdown-toc-pick-point-on-entity-surface-at-canvas-coords">2. Pick point on entity surface at canvas coords</a></li>
  <li><a href="#pick-entity-with-world-space-ray" id="markdown-toc-pick-entity-with-world-space-ray">3. Pick entity with World-space ray</a></li>
  <li><a href="#pick-point-on-entity-surface-with-world-space-ray" id="markdown-toc-pick-point-on-entity-surface-with-world-space-ray">4. Pick point on entity surface with World-space ray</a></li>
  <li><a href="#pros-and-cons" id="markdown-toc-pros-and-cons">Pros and cons</a></li>
  <li><a href="#work-remaining" id="markdown-toc-work-remaining">Work remaining</a></li>
  <li><a href="#references" id="markdown-toc-references">References</a>    <ul>
      <li><a href="#hanrahan1990" id="markdown-toc-hanrahan1990">Hanrahan1990</a></li>
      <li><a href="#lander2000" id="markdown-toc-lander2000">Lander2000</a></li>
    </ul>
  </li>
</ul>

  </div>
</section>
<!-- /#table-of-contents -->

<p><strong><a href="http://xeogl.org">xeogl</a></strong> is a WebGL-based engine for 3D visualization. In this article, I’ll describe xeogl’s
GPU-assisted picking system, which uses a multi-layer color-indexing rendering algorithm to ray-pick scene entities
in linear time complexity.
<br /><br />
<img src="http://xeolabs.com/images/xeogl/pickingTeapots.png" alt="" /></p>

<h2 id="introduction">Introduction</h2>

<p>The color-indexed “WYSIWYG” picking method, which takes advantage of graphics hardware to render scene objects into an auxiliary frame buffer,
was first proposed by Robin Forrest in the mid-1980s and used in 3D painting by Hanrahan and Haeberli [<a href="#hanrahan1990">Hanrahan1990</a>]. In their
implementation, each triangle is assigned a unique color which is used as an identifier. Given the cursor’s canvas coordinates and a map of IDs
to triangles, the picked position on the surface can be found by retrieving color values from the frame buffer and mapping them back to triangles.
<br /><br />
Jeff Lander extended this approach to calculate the exact intersection information, ie. the barycentric coordinates
within the intersected triangle. By setting additional color values to the three triangle vertices, he calculated the barycentric
coordinates by interpolation after the rasterization stage [<a href="#lander2000">Lander2000</a>].
<br />
<br />
xeogl uses a three-stage picking technique:</p>

<ol>
  <li>Color-indexed method to find the picked object.</li>
  <li>Color-indexed method to find the picked triangle within the object.</li>
  <li>Calculations in JavaScript to find the barycentric coordinates, position, normal and UV.</li>
</ol>

<h2 id="four-types-of-picking-in-xeogl">Four types of picking in xeogl</h2>

<p>xeogl supports four types of picking, which are:</p>

<ol>
  <li>pick entity at canvas coordinates,</li>
  <li>pick point on entity surface at canvas coordinates,</li>
  <li>pick entity with World-space ray, and</li>
  <li>pick point on entity surface with World-space ray.</li>
</ol>

<p>Types 1 and 3 just return the picked entity.
<br /><br />Types 2 and 4 return the picked entity, as well as information about the surface intersection, which includes:</p>

<ul>
  <li>the triangle,</li>
  <li>barycentric coordinates within the triangle,</li>
  <li>World space coordinates,</li>
  <li>View space coordinates,</li>
  <li>normal vector, and</li>
  <li>UV coordinates.</li>
</ul>

<p>Note that we’ll only get a normal if the entity’s geometry has normals, and UV coordinates if the
geometry has UVs. xeogl finds the values for these by interpolating within the values for the triangle vertices using
the barycentric coordinates.</p>

<h2 id="pick-entity-at-canvas-coordinates">1. Pick entity at canvas coordinates</h2>

<p>This type of picking is the simplest: we pick the closest entity behind the given canvas coordinates. This is equivalent to
firing a ray through the canvas, down the negative Z-axis, to find the first entity it hits.
<br />
<br />
<a href="http://xeogl.org/examples/#picking_canvas_pickEntity"><img src="http://xeolabs.com/images/xeogl/pickingCanvasEntity.gif" alt="" /></a>
   <br /><a href="http://xeogl.org/examples/#picking_canvas_pickEntity">Run demo</a>
<br />
<br />
To show how to use it, we’ll start by loading a <a href="http://xeogl.org/docs/classes/GLTFModel.html">GLTFModel</a>:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"> <span class="kd">var</span> <span class="nx">gearbox</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">xeogl</span><span class="p">.</span><span class="nx">GLTFModel</span><span class="p">({</span>
     <span class="na">src</span><span class="p">:</span> <span class="s2">"models/gltf/gearbox/gearbox_assy.gltf"</span>
 <span class="p">});</span> </code></pre></figure>

<p>With our model loaded and sitting in the middle of our canvas, we’ll try picking an entity at some canvas coordinates:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"> <span class="kd">var</span> <span class="nx">hit</span> <span class="o">=</span> <span class="nx">gearbox</span><span class="p">.</span><span class="nx">scene</span><span class="p">.</span><span class="nx">pick</span><span class="p">({</span>
     <span class="na">canvasPos</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span><span class="mi">400</span><span class="p">]</span>
 <span class="p">});</span> </code></pre></figure>

<p>If we hit an entity, then we’ll get a result containing a reference to it:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"> <span class="k">if</span> <span class="p">(</span><span class="nx">hit</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Picked an entity</span>
     <span class="kd">var</span> <span class="nx">entity</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">entity</span><span class="p">;</span>
 <span class="p">}</span> </code></pre></figure>

<p>We can also listen for pick hits on individual entities:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript">  <span class="kd">var</span> <span class="nx">entity</span> <span class="o">=</span> <span class="nx">gearbox</span><span class="p">.</span><span class="nx">entities</span><span class="p">[</span><span class="s2">"gearbox#someGear"</span><span class="p">];</span>
  <span class="nx">entity</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"picked"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hit</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//...</span>
 <span class="p">});</span></code></pre></figure>

<p>Internally, xeogl performs the following steps for this type of picking:</p>

<ol>
  <li>User picks at canvas coordinates.</li>
  <li>Render the scene to an auxiliary frame buffer, filling each entity with a unique colour that is the RBGA-encoded
index of its position within xeogl’s internal display list.</li>
  <li>Read the colour from the framebuffer at the canvas coordinates, map the colour back to the entity in the display list.</li>
  <li>Return a hit result containing the entity.</li>
</ol>

<h2 id="pick-point-on-entity-surface-at-canvas-coords">2. Pick point on entity surface at canvas coords</h2>

<p>Like the previous type of picking, this one also picks the closest entity behind the given canvas coordinates, but also
gets geometric information about the point on the entity’s surface that lies right behind those canvas coordinates.
 <br />
 <br />
<a href="http://xeogl.org/examples/#picking_canvas_pickSurface"><img src="http://xeolabs.com/images/xeogl/pickingCanvasEntitySurface.gif" alt="" /></a>
   <br /><a href="http://xeogl.org/examples/#picking_canvas_pickSurface">Run demo</a>
<br />
<br />
Reusing the scene from the previous example, we’ll pick again at the canvas coordinates, but this time
 we’ll supply a <code>pickSurface</code> flag to indicate that we want information about the point we’re picking on the surface:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">hit</span> <span class="o">=</span> <span class="nx">gearbox</span><span class="p">.</span><span class="nx">scene</span><span class="p">.</span><span class="nx">pick</span><span class="p">({</span>
    <span class="na">canvasPos</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span><span class="mi">400</span><span class="p">],</span>
    <span class="na">pickSurface</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>    <span class="c1">// &lt;&lt;----- Indicates that we want to pick on surface</span>
<span class="p">});</span></code></pre></figure>

<p>Here’s what we get in the pick result this time:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">if</span> <span class="p">(</span><span class="nx">hit</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Picked an entity</span>

    <span class="kd">var</span> <span class="nx">entity</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">entity</span><span class="p">;</span>        <span class="c1">// Entity we picked</span>
    <span class="kd">var</span> <span class="nx">primitive</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">primitive</span><span class="p">;</span>  <span class="c1">// Type of primitive we picked, usually "triangles"</span>
    <span class="kd">var</span> <span class="nx">primIndex</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">primIndex</span><span class="p">;</span>  <span class="c1">// Index of triangle's first element within Entity's Geometry indices array</span>
    <span class="kd">var</span> <span class="nx">indices</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">indices</span><span class="p">;</span>      <span class="c1">// Value of each of the triangle's vertex indices (a three element array)</span>
    <span class="kd">var</span> <span class="nx">localPos</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">localPos</span><span class="p">;</span>    <span class="c1">// Local-space coordinates</span>
    <span class="kd">var</span> <span class="nx">worldPos</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">worldPos</span><span class="p">;</span>    <span class="c1">// World-space coordinates</span>
    <span class="kd">var</span> <span class="nx">viewPos</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">viewPos</span><span class="p">;</span>      <span class="c1">// View-space coordinates</span>
    <span class="kd">var</span> <span class="nx">bary</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">bary</span><span class="p">;</span>            <span class="c1">// Barycentric coordinates within the triangle</span>
    <span class="kd">var</span> <span class="nx">normal</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">normal</span><span class="p">;</span>        <span class="c1">// Interpolated normal vector within the triangle</span>
    <span class="kd">var</span> <span class="nx">uv</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">uv</span><span class="p">;</span>                <span class="c1">// Interpolated UVs within the triangle</span>
<span class="p">}</span></code></pre></figure>

<p>We can then get the triangle vertices like so:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">entity</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">entity</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">geometry</span><span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">geometry</span><span class="p">;</span>

<span class="c1">// Get indices for each of the vertices of the picked triangle</span>

<span class="kd">var</span> <span class="nx">primIndex</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">primIndex</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">indexA</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="nx">primIndex</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">indexB</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="nx">primIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">indexC</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="nx">primIndex</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>

<span class="c1">// Get the triangle's local-space vertex positions</span>

<span class="kd">var</span> <span class="nx">ax</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">position</span><span class="p">[</span><span class="nx">indexA</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">ay</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">position</span><span class="p">[</span><span class="nx">indexA</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">az</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">position</span><span class="p">[</span><span class="nx">indexA</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>

<span class="kd">var</span> <span class="nx">bx</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">position</span><span class="p">[</span><span class="nx">indexB</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">by</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">position</span><span class="p">[</span><span class="nx">indexB</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">bz</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">position</span><span class="p">[</span><span class="nx">indexB</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">cx</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">position</span><span class="p">[</span><span class="nx">indexC</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">cy</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">position</span><span class="p">[</span><span class="nx">indexC</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">cz</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">position</span><span class="p">[</span><span class="nx">indexC</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>

<span class="c1">// Another way to get the indices</span>
<span class="kd">var</span> <span class="nx">indexABC</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">indices</span><span class="p">;</span></code></pre></figure>

<p>Internally, xeogl performs the following steps for this type of picking:</p>

<ol>
  <li>User ray-picks at given canvas coordinates.</li>
  <li>Render the scene to an auxiliary frame buffer, filling each entity with a unique colour that is the RBGA-encoded
index of its position within xeogl’s internal display list.</li>
  <li>Read the colour from the framebuffer at the canvas coordinates, map the colour back to an entity in the display list.</li>
  <li>Clear the framebuffer, then render the triangles of the picked entity to it, filling each triangle with a unique color that
is the RBGA-encoded index of triangle’s first element within the entity’s geometry indices.</li>
  <li>Read the colour from the framebuffer at the canvas coordinates, map the colour back to the picked triangle.</li>
  <li>Now that we have the entity and the triangle, make a ray in clip-space, originating at the eye position and passing through
the near projection plane at a position corresponding to where we picked, then unproject that ray to get a ray in the entity’s
local coordinate space.</li>
  <li>Find the intersection of the ray with the triangle in local space.</li>
  <li>Find the barycentric coordinates of the local-space intersection, then use those to interpolate within the triangle
to Find the normal vector and UV coordinates at that position.</li>
  <li>Return a hit result containing the picked entity, the triangle, and the ray-triangle intersection info (see code example above).</li>
</ol>

<p>For step (4) we lazy-compute extra vertex position and color arrays for the entity geometry, so that we can render each
triangle with a unique flat color. It’s actually very fast, so you’d hardly notice it, even with big meshes - <a href="https://gist.github.com/xeolabs/6e53681b88e00773075e97460a5e7c72">here’s
the math function</a>.</p>

<h2 id="pick-entity-with-world-space-ray">3. Pick entity with World-space ray</h2>

<p>For this type of picking, xeogl fires a ray through the scene, in World-space, to pick the first entity it hits. I originally added
this to support the 3D stylus in some <a href="http://xeolabs.com/articles/xeogl-and-zspace">xeogl demo apps for the zSpace 300</a>.
<br />
<br />
<a href="http://xeogl.org/examples/#picking_raycast_pickEntity"><img src="http://xeolabs.com/images/xeogl/pickingRaycastEntity.gif" alt="" /></a>
   <br /><a href="http://xeogl.org/examples/#picking_raycast_pickEntity">Run demo</a>
<br />
<br />
To show how it’s done, we’ll fire a ray through the scene in World-space, to pick the first entity hit by the ray:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">hit</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">pick</span><span class="p">({</span>
    <span class="na">origin</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">5</span><span class="p">],</span>   <span class="c1">// Ray origin</span>
    <span class="na">direction</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="c1">// Ray direction</span>
    <span class="na">pickSurface</span><span class="p">:</span> <span class="kc">false</span>   <span class="c1">// &lt;&lt;------ Don't want to pick a point on the surface</span>
<span class="p">});</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">hit</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Picked an entity with the ray</span>
     <span class="kd">var</span> <span class="nx">entity</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">entity</span><span class="p">;</span>   <span class="c1">// Entity we picked</span>
<span class="p">}</span></code></pre></figure>

<p>Internally, xeogl performs the following steps for this type of picking:</p>

<ol>
  <li>User picks using a ray in World-space.</li>
  <li>Position the camera to look along the ray.</li>
  <li>Render the scene to an auxiliary frame buffer, filling each entity with a unique colour that is the RBGA-encoded
index of its position within xeogl’s internal display list.</li>
  <li>Restore the camera to its previous position.</li>
  <li>Read the colour from the framebuffer at the canvas coordinates, map the colour back to an entity in the display list.</li>
  <li>Return a hit result containing the entity.</li>
</ol>

<h2 id="pick-point-on-entity-surface-with-world-space-ray">4. Pick point on entity surface with World-space ray</h2>

<p>Like the previous type of picking, this one also involves firing a ray through the scene in World-space, to pick
 an entity, but this time we’re also getting geometric information about the intersection of the ray with the
 entity surface.
<br />
<br />
<a href="http://xeogl.org/examples/#picking_raycast_pickSurface"><img src="http://xeolabs.com/images/xeogl/pickingRaycastEntitySurface.gif" alt="" /></a>
   <br /><a href="http://xeogl.org/examples/#picking_raycast_pickSurface">Run demo</a>
<br />
<br />
Lets fire a ray through the scene in World-space, to pick a 3D position on the surface of the first entity hit by the ray:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">hit</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">pick</span><span class="p">({</span>
    <span class="na">origin</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">5</span><span class="p">],</span>   <span class="c1">// Ray origin</span>
    <span class="na">direction</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="c1">// Ray direction</span>
    <span class="na">pickSurface</span><span class="p">:</span> <span class="kc">true</span>   <span class="c1">// &lt;&lt;--------- Indicates that we want to pick on surface</span>
<span class="p">});</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">hit</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Picked an entity with the ray</span>

    <span class="c1">// Hit result contains the same properties as the second example</span>
    
     <span class="kd">var</span> <span class="nx">entity</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">entity</span><span class="p">;</span>        <span class="c1">// Entity we picked</span>
     <span class="kd">var</span> <span class="nx">primitive</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">primitive</span><span class="p">;</span>  <span class="c1">// Type of primitive we picked, usually "triangles"</span>
     <span class="kd">var</span> <span class="nx">primIndex</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">primIndex</span><span class="p">;</span>  <span class="c1">// Triangle's first index within geometry indices</span>
     <span class="kd">var</span> <span class="nx">indices</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">indices</span><span class="p">;</span>      <span class="c1">// Triangle's vertex indices (a three element array)</span>
     <span class="kd">var</span> <span class="nx">localPos</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">localPos</span><span class="p">;</span>    <span class="c1">// Local-space coordinates within the triangle</span>
     <span class="kd">var</span> <span class="nx">worldPos</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">worldPos</span><span class="p">;</span>    <span class="c1">// World-space coordinates within the triangle</span>
     <span class="kd">var</span> <span class="nx">viewPos</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">viewPos</span><span class="p">;</span>      <span class="c1">// View-space coordinates within the triangle</span>
     <span class="kd">var</span> <span class="nx">bary</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">bary</span><span class="p">;</span>            <span class="c1">// Barycentric coordinates within the triangle</span>
     <span class="kd">var</span> <span class="nx">normal</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">normal</span><span class="p">;</span>        <span class="c1">// Interpolated normal vector within the triangle</span>
     <span class="kd">var</span> <span class="nx">uv</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">uv</span><span class="p">;</span>                <span class="c1">// Interpolated UVs within the triangle</span>
<span class="p">}</span></code></pre></figure>

<p>Internally, xeogl performs the following steps for this type of picking:</p>

<ol>
  <li>User picks using a ray in World-space.</li>
  <li>Position the camera to look along the ray.</li>
  <li>Render the scene to an auxiliary frame buffer, filling each entity with a unique colour that is the RBGA-encoded
index of its position within xeogl’s internal display list.</li>
  <li>Read the colour from the framebuffer at the canvas coordinates, map the colour back to an entity in the display list.</li>
  <li>Clear the framebuffer, then render the triangles of the picked entity to it, filling each triangle with a unique color that
is the RBGA-encoded index of the triangle’s first element within the entity’s geometry indices.</li>
  <li>Read the colour from the framebuffer at the canvas coordinates, map the colour back to the picked triangle.</li>
  <li>Restore the camera to its previous position.</li>
  <li>Now that we have the entity and the triangle, make a ray in clip-space, originating at the eye position and passing through
the near projection plane at a position corresponding to where we picked, then unproject that ray to get a ray in the entity’s
local coordinate space.</li>
  <li>Find the intersection of the ray with the triangle in local space.</li>
  <li>Find the barycentric coordinates of the local-space intersection, then use those to interpolate within the triangle
to find the normal vector and UV coordinates at that position.</li>
  <li>Return a hit result containing the picked entity, the triangle, and the ray-triangle intersection info (see code example above).</li>
</ol>

<h2 id="pros-and-cons">Pros and cons</h2>

<p>Ray-picking usually involves testing a ray for intersection with each object’s bounding box,
then having picked an object, testing the ray for intersection with each of the object’s triangles. This is normally done
on the CPU, with the assistance of a spatial lookup structure, such as a KD-tree. I believe this is how its done in THREE.js.
<br /><br />
Compared to the usual technique, xeogl will be faster for huge numbers of objects and triangles, since it avoids these
CPU-intensive calculations. There are some disadvantages, however:</p>

<ul>
  <li>xeogl’s ray-picking technique only works for triangles so far. It should be possible to extend it to support line segments though.</li>
  <li>The CPU-intensive technique can find multiple objects that intersect a ray, while xeogl’s technique only finds the closest
intersecting object to the ray origin.</li>
  <li>As mentioned when <a href="#pick-point-on-entity-surface-with-world-space-ray">ray-picking triangles</a>, xeogl lazy-computes extra
vertex position and color arrays for each entity we’re about to ray-pick a triangle from, so that we can render each of its
triangles with a unique flat color. That happens on-the-fly, just before we attempt to pick a triangle on the entity,
 and can’t be deferred to xeogl’s’ frame-budgeted task queue (like most computationally-intensive things in xeogl), because
 we need those arrays immediately. Therefore there can be a moment’s delay when picking a complex entity for the first time,
 plus the sudden memory needs for those two extra arrays. Since those extra arrays belong to the geometry, which can be
 instanced by multiple entities, this can be mitigated if we’re able to share (instance) our geometries among many entities. For example,
if we have a scene made up mostly of cubes, where we have one cube geometry shared by all our entities, then when we ray-pick
 our entities, we’re only calculating those arrays once, for the shared geometry.</li>
</ul>

<h2 id="work-remaining">Work remaining</h2>

<ul>
  <li>When rendering to auxiliary frame buffers for ray-picking, xeogl renders the whole canvas-sized viewport. That’s wasteful
in terms of GPU efficiency and memory, so I need reduce the picking framebuffer, and temporarily the picking viewport, to 1x1 size.</li>
  <li>As mentioned in the previous section, I also need to extend the ray-picking technique to select line segments.</li>
</ul>

<h2 id="references">References</h2>

<h3 id="hanrahan1990">Hanrahan1990</h3>

<p>P. Hanrahan and P. Haeberli, “Direct WYSIWYG painting and texturing on 3D shapes,” ACM SIGGRAPH Computer Graphics, vol. 24, no. 4, pp. 215–223, 1990. View at Publisher · View at Google Scholar</p>

<h3 id="lander2000">Lander2000</h3>

<p>J. Lander, “Haunted trees for halloween,” Game Developer Magazine, vol. 7, no. 11, pp. 17–21, 2000. View at Google Scholar</p>

      <hr />
      <footer role="contentinfo">
        <div class="article-author-bottom">
          <img src="http://xeolabs.com/images/avatar.jpg" class="bio-photo" alt="xeolabs bio photo"></a>
<h3><a href="http://xeolabs.com/about/">xeolabs</a></h3>
<p><b>Lindsay Kay</b><br><br><i>3D software engineer / WebGL developer</i></p>
<a href="http://twitter.com/xeolabs" class="author-social" target="_blank"><i class="icon-twitter"></i> Twitter</a>
<a href="http://linkedin.com/in/lindsaystanleykay" class="author-social" target="_blank"><i class="icon-linkedin"></i> LinkedIn</a>
<a href="http://github.com/xeolabs" class="author-social" target="_blank"><i class="icon-github"></i> Github</a>
<br>
<hr>
<p style="text-align: center;"><a href="http://xeolabs.com/pdfs/OpenGLInsights.pdf"><img style="text-align: center; width: 80%;" src="http://xeolabs.com/images/scenejs/OpenGLInsights2.jpg"></a><br>
    <i>My chapter on <a href="http://scenejs.org">SceneJS</a> for OpenGL Insights is now <a href="http://xeolabs.com/pdfs/OpenGLInsights.pdf">free to download!</a></i></p>

        </div>
        <p class="byline"><strong>GPU-Assisted Picking in xeogl</strong> was published on <time datetime="2017-08-01T00:00:00+00:00" itemprop="datePublished">August 01, 2017</time> and last modified on <time datetime="2017-30-08" itemprop="dateModified">2017-30-08</time> by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name"><a href="http://xeolabs.com/about" title="About xeolabs" itemprop="url">xeolabs</a></span></span>.</p>
      </footer>

        <!---->
        <!--<br><br>-->
        <!--<div id="disqus_thread"></div>-->
        <!--<script type="text/javascript">-->
            <!--/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */-->
            <!--var disqus_shortname = 'xeographics'; // required: replace example with your forum shortname-->

            <!--/* * * DON'T EDIT BELOW THIS LINE * * */-->
            <!--(function() {-->
                <!--var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;-->
                <!--dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';-->
                <!--(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);-->
            <!--})();-->
        <!--</script>-->
        <!--<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>-->
        <!--<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>-->
        <!---->
    </div><!-- /.article-wrap -->
  </article>

</div><!-- /#main -->


<div class="footer-wrap">
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://xeolabs.com/articles">View all articles</a>)</small></h4>
    <ul>
    
      
      
      
    
      
      
      
    
      
      
      
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  <footer>
    <span>&copy; 2019 xeolabs. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/">Minimal Mistakes</a> theme.</span>

  </footer>
</div><!-- /.footer-wrap -->

<!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>-->
<!--<script src="http://xeolabs.com/assets/js/vendor/jquery-1.9.1.min.js"></script>-->
<!--<script src="http://xeolabs.com/assets/js/vendor/jquery.gifplayer.js"></script>-->
<!--<link rel="stylesheet" href="http://xeolabs.com/assets/css/gifplayer.css" />-->
<!--<script src="http://xeolabs.com/assets/js/scripts.min.js"></script>-->


<!--<script>-->
    <!--$(document).ready( function(){-->
        <!--$('.gifplayer').gifplayer();-->
    <!--});-->
<!--</script>-->



</body>
</html>
